Notas rápidas de testeo y recordatorio (ACTUALIZADO 2025-11-20)

## ESTADO ACTUAL - VERIFICADO ✅
- ✅ Servidor Express corriendo en http://localhost:3000
- ✅ Base de datos MySQL (farmacia_db) conectada y funcional
- ✅ Postman: todos los endpoints responden correctamente
- ✅ TablePlus: visualiza BD con relaciones Article↔Category
- ✅ node_modules: reinstalados y sin errores
- ✅ Rutas: todas configuradas correctamente en backend/

## PRUEBAS EN POSTMAN
- GET http://localhost:3000/articles -> devuelve 13 artículos ✅
- GET http://localhost:3000/articles/1 -> detalle funcionando ✅
- POST http://localhost:3000/articles -> crear artículo funciona
- PATCH http://localhost:3000/articles/:id -> actualizar funciona
- DELETE http://localhost:3000/articles/:id -> eliminar funciona

## ESTRUCTURA ACTUAL
```
farmacia-backend/
├── backend/                    (Proyecto Express.js)
│   ├── server.js
│   ├── .env (configuración)
│   ├── models/                 (User, Article, Category, Order, OrderItem)
│   ├── controllers/            (articleController, userController, etc)
│   ├── routes/                 (rutas organizadas por recurso)
│   ├── middlewares/            (validateArticle, errorHandler)
│   ├── seeders/                (datos de prueba: 13 artículos, 4 categorías, 1 usuario)
│   ├── public/                 (archivos estáticos)
│   └── node_modules/           (dependencias)
├── FrontFarmacia/              (Frontend React - NUEVO)
├── .env.example
├── .gitignore
└── .prettierrc
```
  - GET http://localhost:3000/articles -> devuelve todos los artículos (ahora con categoryId)
  - GET http://localhost:3000/articles/:id -> detalle de artículo
  - POST http://localhost:3000/articles -> crear artículo
    - Campos: name (string), price (number, max 2 decimales), stock (int), image (url opcional), categoryId (int opcional)
  - POST inválido ejemplos:
    - price con más de 2 decimales -> debe devolver 400 (validación de precio)
    - name duplicado -> debe devolver 400 (validación de unicidad en app)
    - categoryId inexistente -> debe devolver 400 (validación existencia categoría)

- Probar en TablePlus:
  - SELECT id, name, categoryId, price, stock FROM articles; -> revisar categoryId asignado
  - SELECT id, name FROM categories; -> revisar que existan las categorías
  - Ver duplicados: SELECT name, COUNT(*) FROM articles GROUP BY name HAVING COUNT(*) > 1;

- Advertencias importantes:
  - El modelo `Article.name` tiene `unique: true` en el modelo, pero la constraint en la base de datos solo existirá si recreás las tablas o añadís un índice único manualmente.
    - Opción segura: crear una migración o ejecutar ALTER TABLE para añadir un índice único (recomendado si querés preservar datos).
    - Opción destructiva: ejecutar `npm run tables` (ejecuta createDatabaseTables.js con sync({ force: true })) que borra todos los datos y recrea tablas con los nuevos constraints.

- Siguientes pasos recomendados:
  1) Verificar que las categorías fueron creadas (ejecutar el seeder de categories o `npm run seeders`).
  2) Testear creación de artículos con categoryId correcto en Postman.
  3) Considerar añadir UI de administración para crear/editar categorías (dashboard).
  4) Probar rutas protegidas con JWT (por ejemplo `GET /users` usando el header `Authorization: Bearer <token>`) - PENDIENTE

- Otros apuntes:
  - Si necesitas que el endpoint devuelva la categoria con nombre en el artículo, podemos actualizar el controlador `index` y `show` para `include: Category`.
  - Para producción, añadir sanitización XSS en campos de texto y rate-limiting.

Guardá esto como referencia antes de ejecutar acciones destructivas.

----------------------------------------------------------------------------------------------

PENDIENTES / TODO

FASE 2 - CRUD Artículos
✅ GET /articles (listar todos)
✅ GET /articles/:id (detalle)
✅ POST /articles (crear con validaciones)
✅ PATCH /articles/:id (actualizar)
✅ DELETE /articles/:id (eliminar)

FASE 3 - Validaciones
✅ name: obligatorio, 3-100 caracteres, único
✅ price: obligatorio, número con máx 2 decimales, > 0
✅ stock: opcional, entero >= 0
✅ categoryId: validar existencia en tabla categories
✅ description: opcional, máx 500 caracteres
✅ image: opcional, URL válida
✅ Middleware de error centralizado (errorHandler.js)

FASE 4 - Seeders
✅ articleSeeder.js (13 productos con categoryId)
✅ categorySeeder.js (4 categorías)
✅ userSeeder.js (usuario test)

FASE 5 - Categorías
✅ Modelo Category creado
✅ Relación Article belongsTo Category
✅ Validación de categoryId en POST/PATCH (articles)
✅ Seeders de 5 categorías ejecutados (Medicamentos, Cuidado Personal, Suplementos, Ofertas, Otros)
✅ CRUD para Categories COMPLETADO:
   ✅ GET /categories - lista todas las categorías
   ✅ GET /categories/:id - obtiene una categoría por ID
   ✅ POST /categories - crear nueva categoría con validaciones
   ✅ PATCH /categories/:id - actualizar categoría
   ✅ DELETE /categories/:id - eliminar categoría (previene si tiene artículos)
✅ Validaciones para categorías (nombre único, 3-100 caracteres)
✅ GET /articles devuelve cada artículo CON su categoría incluida
✅ GET /articles/:id devuelve artículo CON su categoría incluida
✅ Frontend puede agrupar artículos por categoría sin problema
✅ Verificado: Postman + TablePlus + Node.js scripts

FASE 5.1 - Filtrado por Categoría (PENDIENTE - Próximos días)
⏳ Implementar query parameter: GET /articles?categoryId=X
⏳ Backend: filtrar artículos por categoryId en el controlador
⏳ Frontend: agregar botones/selector de categoría
⏳ Frontend: consumir endpoint con parámetro y actualizar UI
⏳ Nota: no es excluyente con la opción 2 implementada; ambas se complementan


FASE 6 - Usuarios + Autenticación (COMPLETADO ✅)
✅ Modelo User ya existe con campos necesarios
✅ Contraseña hasheada con bcrypt en registro
✅ Registro (POST /users/register) genera JWT automáticamente
✅ Login (POST /users/login) retorna JWT si credenciales son correctas
✅ Middleware authenticateToken implementado (middlewares/authJWT.js)
✅ Rutas protegidas: GET/PATCH/DELETE de usuarios requieren JWT
✅ Middleware `requireAdmin` implementado (middlewares/requireAdmin.js)
✅ Proteger endpoints de artículos/categorías para admin (POST/PATCH/DELETE)
✅ Seeder actualizado: se creó usuario admin `admin@farmauy.com` (contraseña: `12345678`) - idempotente
Nota: ejecutá `npm run seeders` para asegurarte de que el usuario admin exista en tu DB local.
VERIFICACIÓN PENDIENTE: La creación del usuario admin y la comprobación de permisos (login + accesos a rutas protegidas) quedan pendientes de validación manual por falta de tiempo.

FASE 7 - Ventas / Control de stock (NO INICIADA)
FASE 7 - Ventas / Control de stock (EN PROGRESO)
✅ Modelos `Order` y `OrderItem` existentes
✅ Endpoints implementados: `POST /orders`, `GET /orders`, `GET /orders/:id`, `PATCH /orders/:id`, `DELETE /orders/:id`
✅ `POST /orders` ahora usa transacción para crear orden, crear `OrderItem`s y decrementar stock de artículos de forma atómica
✅ Rutas de órdenes protegidas: crear/listar/mostrar requieren autenticación; actualizar/cancelar requieren rol `admin` (puede ajustarse)
✅ Notas: Si la orden se cancela y estaba en `pending`, el stock se devuelve en `destroy`
Próximos pasos pendientes:
- Permitir que el propietario de la orden (user) también pueda cancelar su orden (actualmente solo admin)
- Agregar validaciones de esquema para `items` en `POST /orders`
- Añadir notificaciones / emails (opcional)

PRUEBAS AUTOMATIZADAS / SCRIPTS DE TEST
- `npm run test:admin` : Ejecuta `scripts/test_admin.js` — hace login con `admin@farmauy.com` y crea un artículo de prueba (usa `Authorization: Bearer <token>` internamente).
- `npm run test:orders` : Ejecuta `scripts/test_orders.js` — hace login con `test@farmauy.com`, crea una orden y luego intenta cancelarla como propietario.

Cómo ejecutar (PowerShell):
```powershell
cd "C:\Users\Dany\Desktop\desarrolloWeb\Segundo semestre\E-Commerce\farmacia-backend\backend"
# Asegurate de levantar el servidor en otra terminal:
npm start
# En esta terminal ejecutar:
npm run test:admin
# o
npm run test:orders
```

Notas:
- Los scripts requieren que el servidor esté corriendo en `http://localhost:3000`.
- Ejecutá `npm run seeders` si no tenés los usuarios/seeders cargados (admin y user de prueba).
- Si necesitás ejecutar el servidor en background desde PowerShell, usá `Start-Job` (ver README.md para ejemplo).

FASE 8 - Dashboard Admin (NO INICIADA - FRONTEND)
⏳ UI para crear/editar/eliminar artículos
⏳ UI para crear/editar categorías
⏳ UI para ver ventas/reportes
⏳ Protección de rutas (solo admin)

NOTAS TÉCNICAS IMPORTANTES
- Base de datos: MySQL (conf. en .env)
- BD actual probablemente tiene datos viejos; si necesitas un clean slate:
  - Opción 1 (safe): Ejecutar migrateAddTables.js (sync({ alter: true })) - preserva datos
  - Opción 2 (clean): Ejecutar npm run tables (sync({ force: true })) - borra todo
- Constraint UNIQUE en Article.name ya está en la DB (creado con migrate o sync)
- Seeders son idempotentes (pueden ejecutarse múltiples veces sin duplicados)
